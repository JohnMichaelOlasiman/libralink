{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/lib/db.ts"],"sourcesContent":["import { neon } from \"@neondatabase/serverless\"\n\nexport function createClient() {\n  const connectionString = process.env.DATABASE_URL\n  if (!connectionString) {\n    throw new Error(\"DATABASE_URL environment variable is not set\")\n  }\n  return neon(connectionString)\n}\n\nexport async function withRetry<T>(fn: () => Promise<T>, retries = 3, baseDelay = 100): Promise<T> {\n  let lastError: Error | null = null\n\n  for (let attempt = 0; attempt < retries; attempt++) {\n    try {\n      return await fn()\n    } catch (error) {\n      lastError = error as Error\n      console.error(`[v0] Database attempt ${attempt + 1}/${retries} failed:`, error)\n\n      if (attempt < retries - 1) {\n        const delay = baseDelay * Math.pow(2, attempt)\n        await new Promise((resolve) => setTimeout(resolve, delay))\n      }\n    }\n  }\n\n  throw lastError\n}\n\nexport async function sql(strings: TemplateStringsArray, ...values: unknown[]) {\n  return withRetry(async () => {\n    const client = createClient()\n    return await client(strings, ...values)\n  })\n}\n\nsql.unsafe = async (query: string, values?: unknown[]) => {\n  return withRetry(async () => {\n    const client = createClient()\n    const result = await client.query(query, values || [])\n    return result\n  })\n}\n\n// Type definitions for database entities\nexport type UserRole = \"student\" | \"faculty\" | \"librarian\" | \"admin\"\nexport type UserStatus = \"active\" | \"inactive\" | \"suspended\"\nexport type BookStatus = \"available\" | \"borrowed\" | \"reserved\" | \"maintenance\"\nexport type BorrowStatus = \"pending\" | \"approved\" | \"declined\" | \"returned\" | \"overdue\"\nexport type ReservationStatus = \"active\" | \"fulfilled\" | \"expired\" | \"cancelled\"\nexport type FineStatus = \"unpaid\" | \"paid\" | \"waived\"\nexport type FineReason = \"overdue\" | \"damage\" | \"lost\" | \"other\"\n\nexport interface User {\n  id: string\n  email: string\n  password_hash: string\n  full_name: string\n  role: UserRole\n  status: UserStatus\n  university_id: string | null\n  university_name: string | null\n  department: string | null\n  phone: string | null\n  avatar_url: string | null\n  id_card_url: string | null\n  email_verified: boolean\n  last_login: Date | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface Author {\n  id: string\n  name: string\n  bio: string | null\n  avatar_url: string | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface Category {\n  id: string\n  name: string\n  description: string | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface Publisher {\n  id: string\n  name: string\n  address: string | null\n  website: string | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface Book {\n  id: string\n  title: string\n  isbn: string | null\n  description: string | null\n  cover_url: string | null\n  publisher_id: string | null\n  publication_year: number | null\n  total_copies: number\n  available_copies: number\n  rating: number\n  rating_count: number\n  status: BookStatus\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface BookWithDetails extends Book {\n  authors: Author[]\n  categories: Category[]\n  publisher: Publisher | null\n}\n\nexport interface BorrowRequest {\n  id: string\n  user_id: string\n  book_id: string\n  status: BorrowStatus\n  requested_at: Date\n  approved_at: Date | null\n  approved_by: string | null\n  due_date: Date | null\n  returned_at: Date | null\n  notes: string | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface BorrowRequestWithDetails extends BorrowRequest {\n  user: User\n  book: Book\n  approver: User | null\n}\n\nexport interface Reservation {\n  id: string\n  user_id: string\n  book_id: string\n  status: ReservationStatus\n  reserved_at: Date\n  expires_at: Date | null\n  fulfilled_at: Date | null\n  cancelled_at: Date | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface ReservationWithDetails extends Reservation {\n  user: User\n  book: Book\n}\n\nexport interface Fine {\n  id: string\n  user_id: string\n  borrow_request_id: string | null\n  book_id: string | null\n  amount: number\n  reason: FineReason\n  status: FineStatus\n  description: string | null\n  paid_at: Date | null\n  created_by: string | null\n  created_at: Date\n  updated_at: Date\n}\n\nexport interface FineWithDetails extends Fine {\n  user: User\n  book: Book | null\n}\n\nexport interface SystemLog {\n  id: string\n  user_id: string | null\n  action: string\n  entity_type: string | null\n  entity_id: string | null\n  details: Record<string, unknown> | null\n  ip_address: string | null\n  user_agent: string | null\n  created_at: Date\n}\n\nexport interface SystemLogWithUser extends SystemLog {\n  user: User | null\n}\n\nexport interface Session {\n  id: string\n  user_id: string\n  token: string\n  expires_at: Date\n  created_at: Date\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEO,SAAS;IACd,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;IACjD,IAAI,CAAC,kBAAkB;QACrB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAA,gSAAI,EAAC;AACd;AAEO,eAAe,UAAa,EAAoB,EAAE,UAAU,CAAC,EAAE,YAAY,GAAG;IACnF,IAAI,YAA0B;IAE9B,IAAK,IAAI,UAAU,GAAG,UAAU,SAAS,UAAW;QAClD,IAAI;YACF,OAAO,MAAM;QACf,EAAE,OAAO,OAAO;YACd,YAAY;YACZ,QAAQ,KAAK,CAAC,CAAC,sBAAsB,EAAE,UAAU,EAAE,CAAC,EAAE,QAAQ,QAAQ,CAAC,EAAE;YAEzE,IAAI,UAAU,UAAU,GAAG;gBACzB,MAAM,QAAQ,YAAY,KAAK,GAAG,CAAC,GAAG;gBACtC,MAAM,IAAI,QAAQ,CAAC,UAAY,WAAW,SAAS;YACrD;QACF;IACF;IAEA,MAAM;AACR;AAEO,eAAe,IAAI,OAA6B,EAAE,GAAG,MAAiB;IAC3E,OAAO,UAAU;QACf,MAAM,SAAS;QACf,OAAO,MAAM,OAAO,YAAY;IAClC;AACF;AAEA,IAAI,MAAM,GAAG,OAAO,OAAe;IACjC,OAAO,UAAU;QACf,MAAM,SAAS;QACf,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,OAAO,UAAU,EAAE;QACrD,OAAO;IACT;AACF"}},
    {"offset": {"line": 60, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/lib/auth.ts"],"sourcesContent":["import { sql, type User, type UserRole } from \"./db\"\nimport { cookies } from \"next/headers\"\nimport crypto from \"crypto\"\n\n// Simple password hashing (in production, use bcrypt)\nfunction hashPassword(password: string): string {\n  return crypto.createHash(\"sha256\").update(password).digest(\"hex\")\n}\n\nfunction verifyPassword(password: string, hash: string): boolean {\n  return hashPassword(password) === hash\n}\n\n// Generate a secure random token\nfunction generateToken(): string {\n  return crypto.randomBytes(32).toString(\"hex\")\n}\n\n// Session duration (7 days)\nconst SESSION_DURATION = 7 * 24 * 60 * 60 * 1000\n\nexport async function signUp(\n  email: string,\n  password: string,\n  fullName: string,\n  universityId?: string,\n  universityName?: string,\n  idCardUrl?: string,\n): Promise<{ user: User | null; error: string | null }> {\n  try {\n    // Check if email already exists\n    const existingUser = await sql`\n      SELECT id FROM users WHERE email = ${email}\n    `\n    if (existingUser.length > 0) {\n      return { user: null, error: \"Email already registered\" }\n    }\n\n    // Check if university ID already exists\n    if (universityId) {\n      const existingId = await sql`\n        SELECT id FROM users WHERE university_id = ${universityId}\n      `\n      if (existingId.length > 0) {\n        return { user: null, error: \"University ID already registered\" }\n      }\n    }\n\n    const passwordHash = hashPassword(password)\n\n    const result = await sql`\n      INSERT INTO users (email, password_hash, full_name, university_id, university_name, id_card_url)\n      VALUES (${email}, ${passwordHash}, ${fullName}, ${universityId || null}, ${universityName || null}, ${idCardUrl || null})\n      RETURNING *\n    `\n\n    return { user: result[0] as User, error: null }\n  } catch (error) {\n    console.error(\"Sign up error:\", error)\n    return { user: null, error: \"Failed to create account\" }\n  }\n}\n\nexport async function signIn(\n  email: string,\n  password: string,\n): Promise<{ user: User | null; token: string | null; error: string | null }> {\n  try {\n    const result = await sql`\n      SELECT * FROM users WHERE email = ${email}\n    `\n\n    if (result.length === 0) {\n      return { user: null, token: null, error: \"Invalid email or password\" }\n    }\n\n    const user = result[0] as User\n\n    if (user.status !== \"active\") {\n      return { user: null, token: null, error: \"Account is not active\" }\n    }\n\n    if (!verifyPassword(password, user.password_hash)) {\n      return { user: null, token: null, error: \"Invalid email or password\" }\n    }\n\n    // Create session\n    const token = generateToken()\n    const expiresAt = new Date(Date.now() + SESSION_DURATION)\n\n    await sql`\n      INSERT INTO sessions (user_id, token, expires_at)\n      VALUES (${user.id}, ${token}, ${expiresAt})\n    `\n\n    // Update last login\n    await sql`\n      UPDATE users SET last_login = NOW() WHERE id = ${user.id}\n    `\n\n    // Log the login\n    await sql`\n      INSERT INTO system_logs (user_id, action, entity_type, entity_id, details)\n      VALUES (${user.id}, 'user_login', 'user', ${user.id}, '{\"method\": \"password\"}')\n    `\n\n    return { user, token, error: null }\n  } catch (error) {\n    console.error(\"Sign in error:\", error)\n    return { user: null, token: null, error: \"Failed to sign in\" }\n  }\n}\n\nexport async function signOut(token: string): Promise<void> {\n  try {\n    await sql`\n      DELETE FROM sessions WHERE token = ${token}\n    `\n  } catch (error) {\n    console.error(\"Sign out error:\", error)\n  }\n}\n\nexport async function getSession(): Promise<{ user: User | null; token: string | null }> {\n  try {\n    const cookieStore = await cookies()\n    const token = cookieStore.get(\"session_token\")?.value\n\n    if (!token) {\n      return { user: null, token: null }\n    }\n\n    const result = await sql`\n      SELECT u.* FROM users u\n      INNER JOIN sessions s ON u.id = s.user_id\n      WHERE s.token = ${token} AND s.expires_at > NOW()\n    `\n\n    if (result.length === 0) {\n      return { user: null, token: null }\n    }\n\n    return { user: result[0] as User, token }\n  } catch (error) {\n    console.error(\"Get session error:\", error)\n    return { user: null, token: null }\n  }\n}\n\nexport async function getUserById(id: string): Promise<User | null> {\n  try {\n    const result = await sql`\n      SELECT * FROM users WHERE id = ${id}\n    `\n    return result.length > 0 ? (result[0] as User) : null\n  } catch (error) {\n    console.error(\"Get user error:\", error)\n    return null\n  }\n}\n\nexport async function requireAuth(): Promise<User> {\n  const { user } = await getSession()\n  if (!user) {\n    throw new Error(\"Unauthorized\")\n  }\n  return user\n}\n\nexport async function requireRole(roles: UserRole[]): Promise<User> {\n  const user = await requireAuth()\n  if (!roles.includes(user.role)) {\n    throw new Error(\"Forbidden\")\n  }\n  return user\n}\n\nexport function isAdmin(user: User): boolean {\n  return user.role === \"admin\"\n}\n\nexport function isLibrarian(user: User): boolean {\n  return user.role === \"librarian\" || user.role === \"admin\"\n}\n\nexport function isStaff(user: User): boolean {\n  return user.role === \"librarian\" || user.role === \"admin\"\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 280, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/lib/actions/book-actions.ts"],"sourcesContent":["\"use server\"\n\nimport { sql, type Book, type BookWithDetails, type Category } from \"@/lib/db\"\nimport { requireRole } from \"@/lib/auth\"\n\nexport async function getBooks(search?: string, category?: string): Promise<BookWithDetails[]> {\n  const result = await sql`\n    SELECT b.*, \n      c.name as category_name\n    FROM books b\n    LEFT JOIN categories c ON b.category_id = c.id\n    ORDER BY b.created_at DESC\n  `\n\n  let books = result as any[]\n\n  // Map to BookWithDetails format\n  books = books.map((book) => ({\n    ...book,\n    authors: book.author_name ? [{ id: \"1\", name: book.author_name }] : [],\n    categories: book.category_name ? [{ id: book.category_id, name: book.category_name }] : [],\n    publisher: book.publisher_name ? { id: \"1\", name: book.publisher_name } : null,\n  }))\n\n  if (search) {\n    const searchLower = search.toLowerCase()\n    books = books.filter(\n      (book) =>\n        book.title.toLowerCase().includes(searchLower) || (book.author_name || \"\").toLowerCase().includes(searchLower),\n    )\n  }\n\n  if (category) {\n    const categoryLower = category.toLowerCase()\n    books = books.filter((book) => (book.category_name || \"\").toLowerCase().includes(categoryLower))\n  }\n\n  return books as BookWithDetails[]\n}\n\nexport async function getBookById(id: string): Promise<BookWithDetails | null> {\n  const result = await sql`\n    SELECT b.*, c.name as category_name\n    FROM books b\n    LEFT JOIN categories c ON b.category_id = c.id\n    WHERE b.id = ${id}\n  `\n\n  if (result.length === 0) return null\n\n  const book = result[0] as any\n  return {\n    ...book,\n    authors: book.author_name ? [{ id: \"1\", name: book.author_name }] : [],\n    categories: book.category_name ? [{ id: book.category_id, name: book.category_name }] : [],\n    publisher: book.publisher_name ? { id: \"1\", name: book.publisher_name } : null,\n  } as BookWithDetails\n}\n\nexport async function getPopularBooks(limit = 6): Promise<BookWithDetails[]> {\n  const result = await sql`\n    SELECT b.*, c.name as category_name\n    FROM books b\n    LEFT JOIN categories c ON b.category_id = c.id\n    ORDER BY b.rating DESC, b.rating_count DESC\n    LIMIT ${limit}\n  `\n\n  return (result as any[]).map((book) => ({\n    ...book,\n    authors: book.author_name ? [{ id: \"1\", name: book.author_name }] : [],\n    categories: book.category_name ? [{ id: book.category_id, name: book.category_name }] : [],\n    publisher: book.publisher_name ? { id: \"1\", name: book.publisher_name } : null,\n  })) as BookWithDetails[]\n}\n\nexport async function getFeaturedBook(): Promise<BookWithDetails | null> {\n  const result = await sql`\n    SELECT b.*, c.name as category_name\n    FROM books b\n    LEFT JOIN categories c ON b.category_id = c.id\n    ORDER BY b.rating DESC\n    LIMIT 1\n  `\n\n  if (result.length === 0) return null\n\n  const book = result[0] as any\n  return {\n    ...book,\n    authors: book.author_name ? [{ id: \"1\", name: book.author_name }] : [],\n    categories: book.category_name ? [{ id: book.category_id, name: book.category_name }] : [],\n    publisher: book.publisher_name ? { id: \"1\", name: book.publisher_name } : null,\n  } as BookWithDetails\n}\n\nexport async function createBook(data: {\n  title: string\n  isbn?: string\n  description?: string\n  cover_url?: string\n  author_name?: string\n  publisher_name?: string\n  category_id?: string\n  publication_year?: number\n  total_copies: number\n}): Promise<{ book: Book | null; error: string | null }> {\n  try {\n    await requireRole([\"librarian\", \"admin\"])\n\n    const result = await sql`\n      INSERT INTO books (\n        title, isbn, description, cover_url, author_name, publisher_name, \n        category_id, publication_year, total_copies, available_copies\n      )\n      VALUES (\n        ${data.title}, \n        ${data.isbn || null}, \n        ${data.description || null}, \n        ${data.cover_url || null}, \n        ${data.author_name || \"Unknown Author\"},\n        ${data.publisher_name || \"\"},\n        ${data.category_id || null}, \n        ${data.publication_year || null}, \n        ${data.total_copies}, \n        ${data.total_copies}\n      )\n      RETURNING *\n    `\n\n    return { book: result[0] as Book, error: null }\n  } catch (error) {\n    console.error(\"Create book error:\", error)\n    return { book: null, error: \"Failed to create book\" }\n  }\n}\n\nexport async function updateBook(\n  id: string,\n  data: {\n    title?: string\n    isbn?: string\n    description?: string\n    cover_url?: string\n    author_name?: string\n    publisher_name?: string\n    category_id?: string\n    publication_year?: number\n    total_copies?: number\n    available_copies?: number\n    status?: string\n  },\n): Promise<{ book: Book | null; error: string | null }> {\n  try {\n    await requireRole([\"librarian\", \"admin\"])\n\n    // Update each field individually\n    if (data.title !== undefined) {\n      await sql`UPDATE books SET title = ${data.title} WHERE id = ${id}`\n    }\n    if (data.isbn !== undefined) {\n      await sql`UPDATE books SET isbn = ${data.isbn} WHERE id = ${id}`\n    }\n    if (data.description !== undefined) {\n      await sql`UPDATE books SET description = ${data.description} WHERE id = ${id}`\n    }\n    if (data.cover_url !== undefined) {\n      await sql`UPDATE books SET cover_url = ${data.cover_url} WHERE id = ${id}`\n    }\n    if (data.author_name !== undefined) {\n      await sql`UPDATE books SET author_name = ${data.author_name} WHERE id = ${id}`\n    }\n    if (data.publisher_name !== undefined) {\n      await sql`UPDATE books SET publisher_name = ${data.publisher_name} WHERE id = ${id}`\n    }\n    if (data.category_id !== undefined) {\n      await sql`UPDATE books SET category_id = ${data.category_id} WHERE id = ${id}`\n    }\n    if (data.publication_year !== undefined) {\n      await sql`UPDATE books SET publication_year = ${data.publication_year} WHERE id = ${id}`\n    }\n    if (data.total_copies !== undefined) {\n      await sql`UPDATE books SET total_copies = ${data.total_copies} WHERE id = ${id}`\n    }\n    if (data.available_copies !== undefined) {\n      await sql`UPDATE books SET available_copies = ${data.available_copies} WHERE id = ${id}`\n    }\n    if (data.status !== undefined) {\n      await sql`UPDATE books SET status = ${data.status} WHERE id = ${id}`\n    }\n\n    const result = await sql`SELECT * FROM books WHERE id = ${id}`\n    return { book: result[0] as Book, error: null }\n  } catch (error) {\n    console.error(\"Update book error:\", error)\n    return { book: null, error: \"Failed to update book\" }\n  }\n}\n\nexport async function deleteBook(id: string): Promise<{ error: string | null }> {\n  try {\n    await requireRole([\"librarian\", \"admin\"])\n    await sql`DELETE FROM books WHERE id = ${id}`\n    return { error: null }\n  } catch (error) {\n    console.error(\"Delete book error:\", error)\n    return { error: \"Failed to delete book\" }\n  }\n}\n\nexport async function getCategories(): Promise<Category[]> {\n  const result = await sql`SELECT * FROM categories ORDER BY name`\n  return result as Category[]\n}\n\nexport async function getBookStats() {\n  const stats = await sql`\n    SELECT \n      COUNT(*) as total_books,\n      SUM(total_copies) as total_copies,\n      SUM(available_copies) as available_copies,\n      SUM(total_copies - available_copies) as borrowed_copies\n    FROM books\n  `\n  return stats[0]\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 580, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/lib/actions/borrow-actions.ts"],"sourcesContent":["\"use server\"\n\nimport { sql, type BorrowRequest, type BorrowRequestWithDetails, type BorrowStatus } from \"@/lib/db\"\nimport { requireRole, getSession } from \"@/lib/auth\"\n\nexport async function getBorrowRequests(status?: BorrowStatus): Promise<BorrowRequestWithDetails[]> {\n  let query = `\n    SELECT br.*, \n      jsonb_build_object('id', u.id, 'full_name', u.full_name, 'email', u.email, 'avatar_url', u.avatar_url, 'university_id', u.university_id) as user,\n      jsonb_build_object('id', b.id, 'title', b.title, 'cover_url', b.cover_url, 'isbn', b.isbn) as book,\n      CASE WHEN ap.id IS NOT NULL THEN jsonb_build_object('id', ap.id, 'full_name', ap.full_name) ELSE NULL END as approver\n    FROM borrow_requests br\n    INNER JOIN users u ON br.user_id = u.id\n    INNER JOIN books b ON br.book_id = b.id\n    LEFT JOIN users ap ON br.approved_by = ap.id\n  `\n\n  if (status) {\n    query += ` WHERE br.status = '${status}'`\n  }\n\n  query += ` ORDER BY br.requested_at DESC`\n\n  const result = await sql.unsafe(query)\n  return result as BorrowRequestWithDetails[]\n}\n\nexport async function getUserBorrowedBooks(userId: string): Promise<BorrowRequestWithDetails[]> {\n  const result = await sql`\n    SELECT br.*, \n      jsonb_build_object('id', u.id, 'full_name', u.full_name, 'email', u.email, 'avatar_url', u.avatar_url) as user,\n      jsonb_build_object('id', b.id, 'title', b.title, 'cover_url', b.cover_url, 'isbn', b.isbn) as book,\n      CASE WHEN ap.id IS NOT NULL THEN jsonb_build_object('id', ap.id, 'full_name', ap.full_name) ELSE NULL END as approver\n    FROM borrow_requests br\n    INNER JOIN users u ON br.user_id = u.id\n    INNER JOIN books b ON br.book_id = b.id\n    LEFT JOIN users ap ON br.approved_by = ap.id\n    WHERE br.user_id = ${userId} AND br.status IN ('approved', 'overdue')\n    ORDER BY br.approved_at DESC\n  `\n  return result as BorrowRequestWithDetails[]\n}\n\nexport async function createBorrowRequest(\n  bookId: string,\n): Promise<{ request: BorrowRequest | null; error: string | null }> {\n  try {\n    const { user } = await getSession()\n    if (!user) {\n      return { request: null, error: \"Not authenticated\" }\n    }\n\n    // Check if book is available\n    const book = await sql`SELECT available_copies FROM books WHERE id = ${bookId}`\n    if (book.length === 0) {\n      return { request: null, error: \"Book not found\" }\n    }\n    if (book[0].available_copies <= 0) {\n      return { request: null, error: \"No copies available\" }\n    }\n\n    // Check for existing pending request\n    const existing = await sql`\n      SELECT id FROM borrow_requests \n      WHERE user_id = ${user.id} AND book_id = ${bookId} AND status = 'pending'\n    `\n    if (existing.length > 0) {\n      return { request: null, error: \"You already have a pending request for this book\" }\n    }\n\n    const result = await sql`\n      INSERT INTO borrow_requests (user_id, book_id, status)\n      VALUES (${user.id}, ${bookId}, 'pending')\n      RETURNING *\n    `\n\n    return { request: result[0] as BorrowRequest, error: null }\n  } catch (error) {\n    console.error(\"Create borrow request error:\", error)\n    return { request: null, error: \"Failed to create request\" }\n  }\n}\n\nexport async function approveBorrowRequest(requestId: string, dueDate: Date): Promise<{ error: string | null }> {\n  try {\n    const user = await requireRole([\"librarian\", \"admin\"])\n\n    // Get the request\n    const request = await sql`SELECT * FROM borrow_requests WHERE id = ${requestId}`\n    if (request.length === 0) {\n      return { error: \"Request not found\" }\n    }\n\n    const bookId = request[0].book_id\n\n    // Update the request\n    await sql`\n      UPDATE borrow_requests \n      SET status = 'approved', approved_at = NOW(), approved_by = ${user.id}, due_date = ${dueDate}\n      WHERE id = ${requestId}\n    `\n\n    // Decrease available copies\n    await sql`\n      UPDATE books SET available_copies = available_copies - 1 WHERE id = ${bookId}\n    `\n\n    // Log the action\n    await sql`\n      INSERT INTO system_logs (user_id, action, entity_type, entity_id, details)\n      VALUES (${user.id}, 'borrow_approved', 'borrow_request', ${requestId}, '{}')\n    `\n\n    return { error: null }\n  } catch (error) {\n    console.error(\"Approve borrow request error:\", error)\n    return { error: \"Failed to approve request\" }\n  }\n}\n\nexport async function declineBorrowRequest(requestId: string, reason?: string): Promise<{ error: string | null }> {\n  try {\n    const user = await requireRole([\"librarian\", \"admin\"])\n\n    await sql`\n      UPDATE borrow_requests \n      SET status = 'declined', approved_by = ${user.id}, notes = ${reason || null}\n      WHERE id = ${requestId}\n    `\n\n    return { error: null }\n  } catch (error) {\n    console.error(\"Decline borrow request error:\", error)\n    return { error: \"Failed to decline request\" }\n  }\n}\n\nexport async function returnBook(requestId: string): Promise<{ fine: number | null; error: string | null }> {\n  try {\n    const user = await requireRole([\"librarian\", \"admin\"])\n\n    // Get the request\n    const request = await sql`SELECT * FROM borrow_requests WHERE id = ${requestId}`\n    if (request.length === 0) {\n      return { fine: null, error: \"Request not found\" }\n    }\n\n    const req = request[0]\n    const bookId = req.book_id\n    const userId = req.user_id\n    const dueDate = new Date(req.due_date)\n    const now = new Date()\n\n    // Calculate fine if overdue ($0.50 per day)\n    let fineAmount = 0\n    if (now > dueDate) {\n      const daysOverdue = Math.ceil((now.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24))\n      fineAmount = daysOverdue * 0.5\n    }\n\n    // Update the request\n    await sql`\n      UPDATE borrow_requests \n      SET status = 'returned', returned_at = NOW()\n      WHERE id = ${requestId}\n    `\n\n    // Increase available copies\n    await sql`\n      UPDATE books SET available_copies = available_copies + 1 WHERE id = ${bookId}\n    `\n\n    // Create fine if applicable\n    if (fineAmount > 0) {\n      await sql`\n        INSERT INTO fines (user_id, borrow_request_id, book_id, amount, reason, description, created_by)\n        VALUES (${userId}, ${requestId}, ${bookId}, ${fineAmount}, 'overdue', 'Late return fine', ${user.id})\n      `\n    }\n\n    // Log the action\n    await sql`\n      INSERT INTO system_logs (user_id, action, entity_type, entity_id, details)\n      VALUES (${user.id}, 'book_returned', 'borrow_request', ${requestId}, ${JSON.stringify({ fine: fineAmount })})\n    `\n\n    return { fine: fineAmount, error: null }\n  } catch (error) {\n    console.error(\"Return book error:\", error)\n    return { fine: null, error: \"Failed to return book\" }\n  }\n}\n\nexport async function getBorrowStats() {\n  try {\n    const stats = await sql`\n      SELECT \n        COUNT(*) FILTER (WHERE status = 'pending') as pending,\n        COUNT(*) FILTER (WHERE status = 'approved') as active,\n        COUNT(*) FILTER (WHERE status = 'approved' AND due_date < CURRENT_DATE) as overdue,\n        COUNT(*) FILTER (WHERE status = 'returned') as returned\n      FROM borrow_requests\n    `\n    return stats[0]\n  } catch (error) {\n    console.error(\"Get borrow stats error:\", error)\n    return { pending: 0, active: 0, overdue: 0, returned: 0 }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 850, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/lib/actions/reservation-actions.ts"],"sourcesContent":["\"use server\"\n\nimport { sql, type Reservation, type ReservationWithDetails, type ReservationStatus } from \"@/lib/db\"\nimport { requireRole, getSession } from \"@/lib/auth\"\n\nexport async function getReservations(status?: ReservationStatus): Promise<ReservationWithDetails[]> {\n  try {\n    let query = `\n      SELECT r.*, \n        jsonb_build_object('id', u.id, 'full_name', u.full_name, 'email', u.email, 'avatar_url', u.avatar_url) as user,\n        jsonb_build_object('id', b.id, 'title', b.title, 'cover_url', b.cover_url, 'available_copies', b.available_copies) as book\n      FROM reservations r\n      INNER JOIN users u ON r.user_id = u.id\n      INNER JOIN books b ON r.book_id = b.id\n    `\n\n    if (status) {\n      query += ` WHERE r.status = '${status}'`\n    }\n\n    query += ` ORDER BY r.reserved_at DESC`\n\n    const result = await sql.unsafe(query)\n    return result as ReservationWithDetails[]\n  } catch (error) {\n    console.error(\"Get reservations error:\", error)\n    return []\n  }\n}\n\nexport async function getUserReservations(userId: string): Promise<ReservationWithDetails[]> {\n  try {\n    const result = await sql`\n      SELECT r.*, \n        jsonb_build_object('id', u.id, 'full_name', u.full_name, 'email', u.email) as user,\n        jsonb_build_object('id', b.id, 'title', b.title, 'cover_url', b.cover_url) as book\n      FROM reservations r\n      INNER JOIN users u ON r.user_id = u.id\n      INNER JOIN books b ON r.book_id = b.id\n      WHERE r.user_id = ${userId}\n      ORDER BY r.reserved_at DESC\n    `\n    return result as ReservationWithDetails[]\n  } catch (error) {\n    console.error(\"Get user reservations error:\", error)\n    return []\n  }\n}\n\nexport async function createReservation(\n  bookId: string,\n): Promise<{ reservation: Reservation | null; error: string | null }> {\n  try {\n    const { user } = await getSession()\n    if (!user) {\n      return { reservation: null, error: \"Not authenticated\" }\n    }\n\n    // Check for existing active reservation\n    const existing = await sql`\n      SELECT id FROM reservations \n      WHERE user_id = ${user.id} AND book_id = ${bookId} AND status = 'active'\n    `\n    if (existing.length > 0) {\n      return { reservation: null, error: \"You already have an active reservation for this book\" }\n    }\n\n    // Set expiration date (7 days from now)\n    const expiresAt = new Date()\n    expiresAt.setDate(expiresAt.getDate() + 7)\n\n    const result = await sql`\n      INSERT INTO reservations (user_id, book_id, expires_at)\n      VALUES (${user.id}, ${bookId}, ${expiresAt})\n      RETURNING *\n    `\n\n    return { reservation: result[0] as Reservation, error: null }\n  } catch (error) {\n    console.error(\"Create reservation error:\", error)\n    return { reservation: null, error: \"Failed to create reservation\" }\n  }\n}\n\nexport async function fulfillReservation(reservationId: string): Promise<{ error: string | null }> {\n  try {\n    await requireRole([\"librarian\", \"admin\"])\n\n    await sql`\n      UPDATE reservations \n      SET status = 'fulfilled', fulfilled_at = NOW()\n      WHERE id = ${reservationId}\n    `\n\n    return { error: null }\n  } catch (error) {\n    console.error(\"Fulfill reservation error:\", error)\n    return { error: \"Failed to fulfill reservation\" }\n  }\n}\n\nexport async function cancelReservation(reservationId: string): Promise<{ error: string | null }> {\n  try {\n    await sql`\n      UPDATE reservations \n      SET status = 'cancelled', cancelled_at = NOW()\n      WHERE id = ${reservationId}\n    `\n\n    return { error: null }\n  } catch (error) {\n    console.error(\"Cancel reservation error:\", error)\n    return { error: \"Failed to cancel reservation\" }\n  }\n}\n\nexport async function getReservationStats() {\n  try {\n    const stats = await sql`\n      SELECT \n        COUNT(*) FILTER (WHERE status = 'active') as active,\n        COUNT(*) FILTER (WHERE status = 'fulfilled') as fulfilled,\n        COUNT(*) FILTER (WHERE status = 'expired') as expired,\n        COUNT(*) FILTER (WHERE status = 'cancelled') as cancelled\n      FROM reservations\n    `\n    return stats[0]\n  } catch (error) {\n    console.error(\"Get reservation stats error:\", error)\n    return { active: 0, fulfilled: 0, expired: 0, cancelled: 0 }\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;AAEA;AACA;;;;;AAEO,eAAe,gBAAgB,MAA0B;IAC9D,IAAI;QACF,IAAI,QAAQ,CAAC;;;;;;;IAOb,CAAC;QAED,IAAI,QAAQ;YACV,SAAS,CAAC,mBAAmB,EAAE,OAAO,CAAC,CAAC;QAC1C;QAEA,SAAS,CAAC,4BAA4B,CAAC;QAEvC,MAAM,SAAS,MAAM,yKAAG,CAAC,MAAM,CAAC;QAChC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,EAAE;IACX;AACF;AAEO,eAAe,oBAAoB,MAAc;IACtD,IAAI;QACF,MAAM,SAAS,MAAM,yKAAG,CAAC;;;;;;;wBAOL,EAAE,OAAO;;IAE7B,CAAC;QACD,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,EAAE;IACX;AACF;AAEO,eAAe,kBACpB,MAAc;IAEd,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,kLAAU;QACjC,IAAI,CAAC,MAAM;YACT,OAAO;gBAAE,aAAa;gBAAM,OAAO;YAAoB;QACzD;QAEA,wCAAwC;QACxC,MAAM,WAAW,MAAM,yKAAG,CAAC;;sBAET,EAAE,KAAK,EAAE,CAAC,eAAe,EAAE,OAAO;IACpD,CAAC;QACD,IAAI,SAAS,MAAM,GAAG,GAAG;YACvB,OAAO;gBAAE,aAAa;gBAAM,OAAO;YAAuD;QAC5F;QAEA,wCAAwC;QACxC,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,MAAM,SAAS,MAAM,yKAAG,CAAC;;cAEf,EAAE,KAAK,EAAE,CAAC,EAAE,EAAE,OAAO,EAAE,EAAE,UAAU;;IAE7C,CAAC;QAED,OAAO;YAAE,aAAa,MAAM,CAAC,EAAE;YAAiB,OAAO;QAAK;IAC9D,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO;YAAE,aAAa;YAAM,OAAO;QAA+B;IACpE;AACF;AAEO,eAAe,mBAAmB,aAAqB;IAC5D,IAAI;QACF,MAAM,IAAA,mLAAW,EAAC;YAAC;YAAa;SAAQ;QAExC,MAAM,yKAAG,CAAC;;;iBAGG,EAAE,cAAc;IAC7B,CAAC;QAED,OAAO;YAAE,OAAO;QAAK;IACvB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;YAAE,OAAO;QAAgC;IAClD;AACF;AAEO,eAAe,kBAAkB,aAAqB;IAC3D,IAAI;QACF,MAAM,yKAAG,CAAC;;;iBAGG,EAAE,cAAc;IAC7B,CAAC;QAED,OAAO;YAAE,OAAO;QAAK;IACvB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO;YAAE,OAAO;QAA+B;IACjD;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,QAAQ,MAAM,yKAAG,CAAC;;;;;;;IAOxB,CAAC;QACD,OAAO,KAAK,CAAC,EAAE;IACjB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO;YAAE,QAAQ;YAAG,WAAW;YAAG,SAAS;YAAG,WAAW;QAAE;IAC7D;AACF;;;IA9HsB;IAyBA;IAmBA;IAmCA;IAiBA;IAeA;;AA/GA,uaAAA;AAyBA,uaAAA;AAmBA,uaAAA;AAmCA,uaAAA;AAiBA,uaAAA;AAeA,uaAAA"}},
    {"offset": {"line": 1028, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/lib/actions/auth-actions.ts"],"sourcesContent":["\"use server\"\n\nimport { signIn, signUp, signOut, getSession } from \"@/lib/auth\"\nimport { cookies } from \"next/headers\"\nimport { redirect } from \"next/navigation\"\n\nexport async function loginAction(formData: FormData) {\n  const email = formData.get(\"email\") as string\n  const password = formData.get(\"password\") as string\n\n  const { user, token, error } = await signIn(email, password)\n\n  if (error || !token) {\n    return { error: error || \"Failed to sign in\" }\n  }\n\n  const cookieStore = await cookies()\n  cookieStore.set(\"session_token\", token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    maxAge: 7 * 24 * 60 * 60, // 7 days\n    path: \"/\",\n  })\n\n  // Redirect based on role\n  if (user?.role === \"admin\") {\n    redirect(\"/admin\")\n  } else if (user?.role === \"librarian\") {\n    redirect(\"/librarian\")\n  } else {\n    redirect(\"/dashboard\")\n  }\n}\n\nexport async function registerAction(formData: FormData) {\n  const email = formData.get(\"email\") as string\n  const password = formData.get(\"password\") as string\n  const fullName = formData.get(\"fullName\") as string\n  const universityId = formData.get(\"universityId\") as string\n  const universityName = formData.get(\"universityName\") as string\n\n  const { user, error } = await signUp(email, password, fullName, universityId, universityName)\n\n  if (error || !user) {\n    return { error: error || \"Failed to create account\" }\n  }\n\n  // Auto sign in after registration\n  const { token, error: signInError } = await signIn(email, password)\n\n  if (signInError || !token) {\n    return { error: \"Account created. Please sign in.\" }\n  }\n\n  const cookieStore = await cookies()\n  cookieStore.set(\"session_token\", token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    maxAge: 7 * 24 * 60 * 60,\n    path: \"/\",\n  })\n\n  redirect(\"/dashboard\")\n}\n\nexport async function logoutAction() {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session_token\")?.value\n\n  if (token) {\n    await signOut(token)\n    cookieStore.delete(\"session_token\")\n  }\n\n  redirect(\"/login\")\n}\n\nexport async function getCurrentUser() {\n  const { user } = await getSession()\n  return user\n}\n"],"names":[],"mappings":";;;;;;;;;;;AAEA;AACA;AACA;AAAA;;;;;;AAEO,eAAe,YAAY,QAAkB;IAClD,MAAM,QAAQ,SAAS,GAAG,CAAC;IAC3B,MAAM,WAAW,SAAS,GAAG,CAAC;IAE9B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,MAAM,IAAA,8KAAM,EAAC,OAAO;IAEnD,IAAI,SAAS,CAAC,OAAO;QACnB,OAAO;YAAE,OAAO,SAAS;QAAoB;IAC/C;IAEA,MAAM,cAAc,MAAM,IAAA,kUAAO;IACjC,YAAY,GAAG,CAAC,iBAAiB,OAAO;QACtC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,IAAI,KAAK,KAAK;QACtB,MAAM;IACR;IAEA,yBAAyB;IACzB,IAAI,MAAM,SAAS,SAAS;QAC1B,IAAA,yXAAQ,EAAC;IACX,OAAO,IAAI,MAAM,SAAS,aAAa;QACrC,IAAA,yXAAQ,EAAC;IACX,OAAO;QACL,IAAA,yXAAQ,EAAC;IACX;AACF;AAEO,eAAe,eAAe,QAAkB;IACrD,MAAM,QAAQ,SAAS,GAAG,CAAC;IAC3B,MAAM,WAAW,SAAS,GAAG,CAAC;IAC9B,MAAM,WAAW,SAAS,GAAG,CAAC;IAC9B,MAAM,eAAe,SAAS,GAAG,CAAC;IAClC,MAAM,iBAAiB,SAAS,GAAG,CAAC;IAEpC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAA,8KAAM,EAAC,OAAO,UAAU,UAAU,cAAc;IAE9E,IAAI,SAAS,CAAC,MAAM;QAClB,OAAO;YAAE,OAAO,SAAS;QAA2B;IACtD;IAEA,kCAAkC;IAClC,MAAM,EAAE,KAAK,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,IAAA,8KAAM,EAAC,OAAO;IAE1D,IAAI,eAAe,CAAC,OAAO;QACzB,OAAO;YAAE,OAAO;QAAmC;IACrD;IAEA,MAAM,cAAc,MAAM,IAAA,kUAAO;IACjC,YAAY,GAAG,CAAC,iBAAiB,OAAO;QACtC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,IAAI,KAAK,KAAK;QACtB,MAAM;IACR;IAEA,IAAA,yXAAQ,EAAC;AACX;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,kUAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,kBAAkB;IAEhD,IAAI,OAAO;QACT,MAAM,IAAA,+KAAO,EAAC;QACd,YAAY,MAAM,CAAC;IACrB;IAEA,IAAA,yXAAQ,EAAC;AACX;AAEO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,kLAAU;IACjC,OAAO;AACT;;;IA5EsB;IA6BA;IAgCA;IAYA;;AAzEA,uaAAA;AA6BA,uaAAA;AAgCA,uaAAA;AAYA,uaAAA"}},
    {"offset": {"line": 1131, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jan/Downloads/libra-link-student-app%20%282%29/.next-internal/server/app/dashboard/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getCategories as '00198f10690404f93ca17f21277db7af0b4b5936ac'} from 'ACTIONS_MODULE0'\nexport {getBookStats as '008b5bda8c25d6a2c9dc3676088b36cbd62fe578c8'} from 'ACTIONS_MODULE0'\nexport {getFeaturedBook as '00f7876a40f1a24a2d0597caad0f38264507df0beb'} from 'ACTIONS_MODULE0'\nexport {getBookById as '4047ff4aca3484428d6b1e62f736b488051e48a746'} from 'ACTIONS_MODULE0'\nexport {deleteBook as '408e644af5e721f29fe8bee8bd6aad6bc20275f87b'} from 'ACTIONS_MODULE0'\nexport {createBook as '40b044a932165a4b888d5295ac2e654bebf6f941c8'} from 'ACTIONS_MODULE0'\nexport {getPopularBooks as '40d14c20370251f300c1024fd6763ae7db995555bb'} from 'ACTIONS_MODULE0'\nexport {updateBook as '6037b68650a613e5610d1da678cc063d3abbd06602'} from 'ACTIONS_MODULE0'\nexport {getBooks as '60a953ef573534338d1a7c2a9758c425ec7d26fa5b'} from 'ACTIONS_MODULE0'\nexport {createBorrowRequest as '407c2bfa4f492b876735b43d737eef1ea906a8d184'} from 'ACTIONS_MODULE1'\nexport {createReservation as '40d1e1bef013e4032638d2a38e90df50c41ac4c2b4'} from 'ACTIONS_MODULE2'\nexport {logoutAction as '0039632f10247d81b5a312638e6c83268c5cc2ead4'} from 'ACTIONS_MODULE3'\n"],"names":[],"mappings":";AAAA;AASA;AACA;AACA"}}]
}